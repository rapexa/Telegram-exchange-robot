package handlers

import (
	"sync"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
	"gorm.io/gorm"

	"telegram-exchange-robot/models"
)

// Registration state tracking
var regState = struct {
	m map[int64]string
	sync.RWMutex
}{m: make(map[int64]string)}

var regTemp = struct {
	m map[int64]map[string]string
	sync.RWMutex
}{m: make(map[int64]map[string]string)}

func StartBot(bot *tgbotapi.BotAPI, db *gorm.DB) {
	u := tgbotapi.NewUpdate(0)
	u.Timeout = 60
	updates := bot.GetUpdatesChan(u)

	for update := range updates {
		if update.Message == nil {
			continue
		}

		// Registration flow state machine
		if handleRegistration(bot, db, update.Message) {
			continue
		}

		if update.Message.IsCommand() {
			switch update.Message.Command() {
			case "start":
				handleStart(bot, db, update.Message)
			}
			continue
		}

		// Main menu navigation
		handleMainMenu(bot, db, update.Message)
	}
}

// handleRegistration manages the registration state machine. Returns true if in registration flow.
func handleRegistration(bot *tgbotapi.BotAPI, db *gorm.DB, msg *tgbotapi.Message) bool {
	userID := int64(msg.From.ID)
	regState.RLock()
	state, inReg := regState.m[userID]
	regState.RUnlock()
	if !inReg {
		return false
	}

	if state == "full_name" {
		// Validate Persian full name format
		if !models.ValidatePersianFullName(msg.Text) {
			bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "ÙØ±Ù…Øª Ù†Ø§Ù… ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\nÙ…Ø«Ø§Ù„: Ø¹Ù„ÛŒ Ø§Ø­Ù…Ø¯ÛŒ\n\nÙ†Ú©Ø§Øª Ù…Ù‡Ù…:\nâ€¢ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ø§Ø´Ø¯\nâ€¢ Ø­Ø¯Ø§Ù‚Ù„ Ø¯Ùˆ Ú©Ù„Ù…Ù‡ (Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ) Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª\nâ€¢ Ù‡Ø± Ú©Ù„Ù…Ù‡ Ø­Ø¯Ø§Ù‚Ù„ Û² Ø­Ø±Ù Ø¨Ø§Ø´Ø¯"))
			return true
		}
		// Save full name, ask for Sheba
		saveRegTemp(userID, "full_name", msg.Text)
		setRegState(userID, "sheba")
		bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"))
		return true
	} else if state == "sheba" {
		// Validate Sheba format
		if !models.ValidateSheba(msg.Text) {
			bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "ÙØ±Ù…Øª Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø´Ø¨Ø§ Ø±Ø§ Ø¨Ù‡ ÙØ±Ù…Øª ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\nÙ…Ø«Ø§Ù„: IR520630144905901219088011"))
			return true
		}
		// Save Sheba, ask for card number
		saveRegTemp(userID, "sheba", msg.Text)
		setRegState(userID, "card_number")
		bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"))
		return true
	} else if state == "card_number" {
		// Validate card number format
		if !models.ValidateCardNumber(msg.Text) {
			bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "ÙØ±Ù…Øª Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ø±Ø§ Ø¨Ù‡ ÙØ±Ù…Øª ØµØ­ÛŒØ­ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\nÙ…Ø«Ø§Ù„: 6037998215325563"))
			return true
		}
		// Save card number, complete registration
		saveRegTemp(userID, "card_number", msg.Text)
		regTemp.RLock()
		info := regTemp.m[userID]
		regTemp.RUnlock()
		// Register user using GORM
		err := registerUser(db, userID, info["full_name"], info["sheba"], info["card_number"])
		if err != nil {
			bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."))
			return true
		}
		clearRegState(userID)
		bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!"))
		showMainMenu(bot, msg.Chat.ID)
		return true
	}
	return false
}

func handleStart(bot *tgbotapi.BotAPI, db *gorm.DB, msg *tgbotapi.Message) {
	userID := int64(msg.From.ID)
	user, err := getUserByTelegramID(db, userID)
	if err != nil || user == nil {
		// User doesn't exist, create new user record
		newUser := &models.User{
			Username:   msg.From.UserName,
			TelegramID: userID,
			Registered: false,
		}
		if err := db.Create(newUser).Error; err != nil {
			bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."))
			return
		}
		// Start registration
		setRegState(userID, "full_name")
		regTemp.Lock()
		regTemp.m[userID] = make(map[string]string)
		regTemp.Unlock()
		bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"))
		return
	}

	if !user.Registered {
		// User exists but not registered, start registration
		setRegState(userID, "full_name")
		regTemp.Lock()
		regTemp.m[userID] = make(map[string]string)
		regTemp.Unlock()
		bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:"))
		return
	}

	// Already registered
	showMainMenu(bot, msg.Chat.ID)
}

func handleMainMenu(bot *tgbotapi.BotAPI, db *gorm.DB, msg *tgbotapi.Message) {
	switch msg.Text {
	case "ğŸ’° Ú©ÛŒÙ Ù¾ÙˆÙ„":
		showWalletMenu(bot, msg.Chat.ID)
	case "ğŸ Ù¾Ø§Ø¯Ø§Ø´":
		showRewardsMenu(bot, msg.Chat.ID)
	case "ğŸ“Š Ø¢Ù…Ø§Ø±":
		showStatsMenu(bot, msg.Chat.ID)
	case "ğŸ†˜ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ":
		bot.Send(tgbotapi.NewMessage(msg.Chat.ID, "Ø¨Ø±Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ† ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯: @YourAdminUsername"))
	default:
		showMainMenu(bot, msg.Chat.ID)
	}
}

func showMainMenu(bot *tgbotapi.BotAPI, chatID int64) {
	menu := tgbotapi.NewReplyKeyboard(
		tgbotapi.NewKeyboardButtonRow(
			tgbotapi.NewKeyboardButton("ğŸ’° Ú©ÛŒÙ Ù¾ÙˆÙ„"),
			tgbotapi.NewKeyboardButton("ğŸ Ù¾Ø§Ø¯Ø§Ø´"),
		),
		tgbotapi.NewKeyboardButtonRow(
			tgbotapi.NewKeyboardButton("ğŸ“Š Ø¢Ù…Ø§Ø±"),
			tgbotapi.NewKeyboardButton("ğŸ†˜ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ"),
		),
	)
	msg := tgbotapi.NewMessage(chatID, "Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:")
	msg.ReplyMarkup = menu
	bot.Send(msg)
}

func showWalletMenu(bot *tgbotapi.BotAPI, chatID int64) {
	menu := tgbotapi.NewReplyKeyboard(
		tgbotapi.NewKeyboardButtonRow(
			tgbotapi.NewKeyboardButton("ğŸ’µ Ø¨Ø±Ø¯Ø§Ø´Øª"),
			tgbotapi.NewKeyboardButton("ğŸ“‹ ØªØ§Ø±ÛŒØ®Ú†Ù‡"),
		),
		tgbotapi.NewKeyboardButtonRow(
			tgbotapi.NewKeyboardButton("ğŸ’³ ÙˆØ§Ø±ÛŒØ² USDT"),
			tgbotapi.NewKeyboardButton("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª"),
		),
	)
	msg := tgbotapi.NewMessage(chatID, "Ù…Ù†ÙˆÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„:")
	msg.ReplyMarkup = menu
	bot.Send(msg)
}

func showRewardsMenu(bot *tgbotapi.BotAPI, chatID int64) {
	menu := tgbotapi.NewReplyKeyboard(
		tgbotapi.NewKeyboardButtonRow(
			tgbotapi.NewKeyboardButton("ğŸ”— Ù„ÛŒÙ†Ú© Ø±ÙØ±Ø§Ù„"),
			tgbotapi.NewKeyboardButton("ğŸ’° Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø¯Ø§Ø´"),
		),
		tgbotapi.NewKeyboardButtonRow(
			tgbotapi.NewKeyboardButton("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª"),
		),
	)
	msg := tgbotapi.NewMessage(chatID, "Ù…Ù†ÙˆÛŒ Ù¾Ø§Ø¯Ø§Ø´:")
	msg.ReplyMarkup = menu
	bot.Send(msg)
}

func showStatsMenu(bot *tgbotapi.BotAPI, chatID int64) {
	menu := tgbotapi.NewReplyKeyboard(
		tgbotapi.NewKeyboardButtonRow(
			tgbotapi.NewKeyboardButton("ğŸ“ˆ Ø¢Ù…Ø§Ø± Ø´Ø®ØµÛŒ"),
			tgbotapi.NewKeyboardButton("ğŸ‘¥ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§"),
		),
		tgbotapi.NewKeyboardButtonRow(
			tgbotapi.NewKeyboardButton("â¬…ï¸ Ø¨Ø§Ø²Ú¯Ø´Øª"),
		),
	)
	msg := tgbotapi.NewMessage(chatID, "Ù…Ù†ÙˆÛŒ Ø¢Ù…Ø§Ø±:")
	msg.ReplyMarkup = menu
	bot.Send(msg)
}

// --- Registration state helpers ---
func setRegState(userID int64, state string) {
	regState.Lock()
	regState.m[userID] = state
	regState.Unlock()
}

func clearRegState(userID int64) {
	regState.Lock()
	delete(regState.m, userID)
	regState.Unlock()
	regTemp.Lock()
	delete(regTemp.m, userID)
	regTemp.Unlock()
}

func saveRegTemp(userID int64, key, value string) {
	regTemp.Lock()
	if regTemp.m[userID] == nil {
		regTemp.m[userID] = make(map[string]string)
	}
	regTemp.m[userID][key] = value
	regTemp.Unlock()
}

// --- GORM-based user helpers ---
func getUserByTelegramID(db *gorm.DB, telegramID int64) (*models.User, error) {
	var user models.User
	err := db.Where("telegram_id = ?", telegramID).First(&user).Error
	if err != nil {
		return nil, err
	}
	return &user, nil
}

func registerUser(db *gorm.DB, telegramID int64, fullName, sheba, cardNumber string) error {
	return db.Model(&models.User{}).
		Where("telegram_id = ?", telegramID).
		Updates(map[string]interface{}{
			"full_name":   fullName,
			"sheba":       sheba,
			"card_number": cardNumber,
			"registered":  true,
		}).Error
}
